<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Fruitables - Vegetable Website Template</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <meta content="" name="keywords" />
    <meta content="" name="description" />

    <!-- Google Web Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600&family=Raleway:wght@600;800&display=swap"
      rel="stylesheet"
    />

    <!-- Icon Font Stylesheet -->
    <link
      rel="stylesheet"
      href="https://use.fontawesome.com/releases/v5.15.4/css/all.css"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.1/font/bootstrap-icons.css"
      rel="stylesheet"
    />

    <!-- Libraries Stylesheet -->
    <link href="lib/lightbox/css/lightbox.min.css" rel="stylesheet" />
    <link href="lib/owlcarousel/assets/owl.carousel.min.css" rel="stylesheet" />

    <!-- Customized Bootstrap Stylesheet -->
    <link href="css/bootstrap.min.css" rel="stylesheet" />

    <!-- Template Stylesheet -->
    <link href="css/style.css" rel="stylesheet" />

    <!-- Custom CSS for Related Products -->
    <style>
      #related-products .vesitable-item.fruite-item {
          max-width: 250px;
          margin: 0 auto;
      }
      #related-products .vesitable-img.fruite-img img {
          height: 150px;
          object-fit: cover;
      }
      #related-products .p-4 {
          padding: 10px !important;
      }
      #related-products h4 {
          font-size: 1rem;
          margin-bottom: 5px;
      }
      #related-products p {
          font-size: 0.8rem;
          margin-bottom: 5px;
      }
      #related-products .text-dark.fs-5 {
          font-size: 0.9rem;
      }
      #related-products .btn.add-to-cart {
          font-size: 0.7rem;
          padding: 4px 8px;
      }
      #related-products .text-white.bg-primary {
          font-size: 0.7rem;
          padding: 2px 6px;
      }
      #related-products .owl-nav .owl-prev,
      #related-products .owl-nav .owl-next {
          font-size: 1.2rem;
          width: 30px;
          height: 30px;
          line-height: 30px;
      }
      #related-products .owl-carousel .owl-item {
          padding: 5px;
      }
      @media (max-width: 768px) {
          #related-products .vesitable-item.fruite-item {
              max-width: 200px;
          }
          #related-products .vesitable-img.fruite-img img {
              height: 120px;
          }
      }
      @media (max-width: 576px) {
          #related-products .vesitable-item.fruite-item {
              max-width: 100%;
          }
          #related-products .vesitable-img.fruite-img img {
              height: 100px;
          }
      }
    </style>
  </head>

  <body>
    <!-- Spinner Start -->
    <div
      id="spinner"
      class="show w-100 vh-100 bg-white position-fixed translate-middle top-50 start-50 d-flex align-items-center justify-content-center"
    >
      <div class="spinner-grow text-primary" role="status"></div>
    </div>
    <!-- Spinner End -->

    <!-- Navbar start -->
    <div class="container-fluid fixed-top">
      <div
        class="container topbar d-none d-lg-block"
        style="background-color: rgb(255, 123, 0)"
      >
        <div class="d-flex justify-content-between">
          <div class="top-info ps-2">
            <small class="me-3"
              ><i class="fas fa-map-marker-alt me-2 text-secondary"></i>
              <a id="mapLink" target="_blank" class="text-white"
                >Jr Huancayo 209</a
              ></small
            >
            <small class="me-3"
              ><i class="fas fa-envelope me-2 text-secondary"></i
              ><a id="gmailLink" target="_blank" class="text-white"
                >info@tiendaeyj.com</a
              ></small
            >
          </div>
          <div class="top-link pe-2">
            <a href="#" class="text-white"
              ><small class="text-white mx-2">Politicas de privacidad</small
              >/</a
            >
            <a href="#" class="text-white"
              ><small class="text-white mx-2">Terminos de uso</small>/</a
            >
            <a href="#" class="text-white"
              ><small class="text-white ms-2">Ventas y Rembolsos</small></a
            >
          </div>
        </div>
      </div>
      <div class="container px-0">
        <nav
          class="navbar navbar-light bg-white navbar-expand-xl"
          style="background-color: red"
        >
          <a href="index.html" class="navbar-brand"
            ><h1 class="text-primary display-6" style="color: red">
              E&J Minimarket
            </h1></a
          >
          <button
            class="navbar-toggler py-2 px-3"
            type="button"
            data-bs-toggle="collapse"
            data-bs-target="#navbarCollapse"
          >
            <span class="fa fa-bars text-primary"></span>
          </button>
          <div class="collapse navbar-collapse bg-white" id="navbarCollapse">
            <div class="navbar-nav mx-auto">
              <a href="index.html" class="nav-item nav-link active">Menú</a>
              <a href="shop.html" class="nav-item nav-link">Tienda</a>
              <a href="shop-detail.html" class="nav-item nav-link"
                >Detalles de Tienda</a
              >
              <div class="nav-item dropdown">
                <a
                  href="#"
                  class="nav-link dropdown-toggle"
                  data-bs-toggle="dropdown"
                  >Paginas</a
                >
                <div class="dropdown-menu m-0 bg-secondary rounded-0">
                  <a href="cart.html" class="dropdown-item">Carrito</a>
                  <a href="chackout.html" class="dropdown-item">Verificación</a>
                  <a href="testimonial.html" class="dropdown-item"
                    >Testimonios</a
                  >
                </div>
              </div>
              <a href="contact.html" class="nav-item nav-link">Contacto</a>
            </div>
            <div class="d-flex m-3 me-0">
              <button
                class="btn-search btn border border-secondary btn-md-square rounded-circle bg-white me-4"
                data-bs-toggle="modal"
                data-bs-target="#searchModal"
              >
                <i class="fas fa-search text-primary"></i>
              </button>
              <a href="cart.html" class="position-relative me-4 my-auto">
                <i class="fa fa-shopping-bag fa-2x"></i>
                <span
                  id="cart-count"
                  class="position-absolute bg-secondary rounded-circle d-flex align-items-center justify-content-center text-dark px-1"
                  style="top: -5px; left: 15px; height: 20px; min-width: 20px"
                  >0</span
                >
              </a>
              <a href="Login.html" class="my-auto">
                <i class="fas fa-user fa-2x"></i>
              </a>
            </div>
          </div>
        </nav>
      </div>
    </div>
    <!-- Navbar End -->

    <!-- Modal Search Start -->
    <div
      class="modal fade"
      id="searchModal"
      tabindex="-1"
      aria-labelledby="exampleModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-fullscreen">
        <div class="modal-content rounded-0">
          <div class="modal-header">
            <h5 class="modal-title" id="exampleModalLabel">
              Buscar por palabra clave
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body d-flex align-items-center">
            <div class="input-group w-75 mx-auto d-flex">
              <input
                type="search"
                class="form-control p-3"
                placeholder="keywords"
                aria-describedby="search-icon-1"
              />
              <span id="search-icon-1" class="input-group-text p-3"
                ><i class="fa fa-search"></i
              ></span>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- Modal Search End -->

    <!-- Single Page Header start -->
    <div class="container-fluid page-header py-5">
      <h1 class="text-center text-white display-6">Detalles de producto</h1>
      <ol class="breadcrumb justify-content-center mb-0">
        <li class="breadcrumb-item"><a href="#">Menú</a></li>
        <li class="breadcrumb-item"><a href="#">Paginas</a></li>
        <li class="breadcrumb-item active text-white">Detalles de producto</li>
      </ol>
    </div>
    <!-- Single Page Header End -->

    <!-- Single Product Start -->
    <div class="container-fluid py-5 mt-5">
      <div class="container py-5">
        <div class="row g-4 mb-5">
          <div class="col-lg-8 col-xl-9">
            <div class="row g-4 fruite-item" id="single-product">
              <!-- Single product will be dynamically inserted here -->
            </div>
          </div>
          <div class="col-lg-4 col-xl-3">
            <div class="row g-4 fruite">
              <div class="col-lg-12">
                <div class="input-group w-100 mx-auto d-flex mb-4">
                  <input
                    type="search"
                    class="form-control p-3"
                    placeholder="keywords"
                    aria-describedby="search-icon-1"
                  />
                  <span id="search-icon-1" class="input-group-text p-3"
                    ><i class="fa fa-search"></i
                  ></span>
                </div>
                <div class="mb-4">
                  <h4>Categorias</h4>
                  <ul class="list-unstyled fruite-categorie">
                    <li>
                      <div class="d-flex justify-content-between fruite-name">
                        <a href="#"
                          ><i class="fa-solid fa-bottle-droplet me-2"></i
                          >Bebidas Alcohólicas</a
                        >
                        <span>(3)</span>
                      </div>
                    </li>
                    <li>
                      <div class="d-flex justify-content-between fruite-name">
                        <a href="#"
                          ><i class="fa-solid fa-glass-water me-2"></i
                          >Bebidas</a
                        >
                        <span>(5)</span>
                      </div>
                    </li>
                    <li>
                      <div class="d-flex justify-content-between fruite-name">
                        <a href="#"
                          ><i class="fas fa-apple-alt me-2"></i>Frutas</a
                        >
                        <span>(2)</span>
                      </div>
                    </li>
                    <li>
                      <div class="d-flex justify-content-between fruite-name">
                        <a href="#"
                          ><i class="fa-solid fa-truck-arrow-right me-2"></i
                          >Envío Gratuito</a
                        >
                        <span>(8)</span>
                      </div>
                    </li>
                    <li>
                      <div class="d-flex justify-content-between fruite-name">
                        <a href="#"
                          ><i class="fa-solid fa-fish me-2"></i>Carnes
                          Frescas</a
                        >
                        <span>(5)</span>
                      </div>
                    </li>
                  </ul>
                </div>
              </div>
              <div class="col-lg-12">
                <h4 class="mb-4">Productos destacados</h4>
                <div id="featured-products">
                  <!-- Featured products will be dynamically inserted here -->
                </div>
                <div class="d-flex justify-content-center my-4">
                  <a
                    href="#"
                    class="btn border border-secondary px-4 py-3 rounded-pill text-primary w-100"
                    >Ver más</a
                  >
                </div>
              </div>
              <div class="col-lg-12">
                <div class="position-relative">
                  <img
                    src="img/hero-img-1.png"
                    class="img-fluid w-100 rounded"
                    alt=""
                  />
                  <div
                    class="position-absolute"
                    style="top: 50%; right: 10px; transform: translateY(-50%)"
                  >
                    <h3 class="text-secondary fw-bold">
                      Productos <br />
                      de <br />
                      Calidad
                    </h3>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <h1 class="fw-bold mb-0">Productos relacionados</h1>
        <div class="vesitable">
          <div class="owl-carousel vegetable-carousel justify-content-center" id="related-products">
            <!-- Related products will be dynamically inserted here -->
          </div>
        </div>
      </div>
    </div>
    <!-- Single Product End -->

    <!-- Back to Top -->
    <a
      href="#"
      class="btn btn-primary border-3 border-primary rounded-circle back-to-top"
      ><i class="fa fa-arrow-up"></i
    ></a>

    <div id="main-content11">
      <!-- this is for footer -->
      <!-- Footer End -->
      <!-- Copyright End -->
    </div>

    <!-- JavaScript Libraries -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="lib/easing/easing.min.js"></script>
    <script src="lib/waypoints/waypoints.min.js"></script>
    <script src="lib/lightbox/js/lightbox.min.js"></script>
    <script src="lib/owlcarousel/owl.carousel.min.js"></script>

    <!-- Template Javascript -->
    <script src="js/main.js"></script>
    <script src="js/footer.js"></script>

    <script>
      // Get usuario_id from localStorage
      let usuario_id = localStorage.getItem('id_usuario');

      // Function to fetch and update cart count
      function updateCartCount() {
        if (!usuario_id) {
          document.getElementById('cart-count').textContent = '0';
          return;
        }
        fetch(`http://localhost/minemarket/api/obtener_cantidad_carrito.php?usuario_id=${usuario_id}`)
          .then(response => {
            if (!response.ok) {
              throw new Error('Network response was not ok');
            }
            return response.json();
          })
          .then(data => {
            document.getElementById('cart-count').textContent = data.cantidad || '0';
          })
          .catch(error => {
            console.error('Error fetching cart count:', error);
            document.getElementById('cart-count').textContent = '0';
          });
      }

      document.addEventListener('DOMContentLoaded', () => {
        // Initialize cart count
        updateCartCount();

        // Get product_id from URL
        const urlParams = new URLSearchParams(window.location.search);
        const productId = urlParams.get('product_id');

        if (!productId || isNaN(productId)) {
          document.getElementById('single-product').innerHTML = `
            <div class="col-12">
              <p class="text-danger text-center">Producto no válido.</p>
            </div>
          `;
          return;
        }

        // Show loading state
        const singleProductContainer = document.getElementById('single-product');
        singleProductContainer.innerHTML = `
          <div class="col-12 text-center">
            <div class="spinner-grow text-primary" role="status">
              <span class="visually-hidden">Cargando...</span>
            </div>
          </div>
        `;

        // Fetch single product
        fetch(`http://localhost/minemarket/api/obtener_producto.php?product_id=${productId}`)
          .then(response => {
            if (!response.ok) {
              throw new Error('Network response was not ok');
            }
            return response.json();
          })
          .then(selectedProduct => {
            if (selectedProduct && !selectedProduct.error) {
              singleProductContainer.innerHTML = `
                <div class="col-lg-6">
                  <div class="border rounded fruite-img">
                    <img src="${selectedProduct.imagen_url}" class="img-fluid rounded" alt="${selectedProduct.nombre}" />
                  </div>
                </div>
                <div class="col-lg-6">
                  <h4 class="fw-bold mb-3">${selectedProduct.nombre}</h4>
                  <p class="mb-3">Categoría: ${selectedProduct.categoria_nombre}</p>
                  <h5 class="fw-bold fs-5 mb-3">S/${parseFloat(selectedProduct.precio).toFixed(2)}</h5>
                  <div class="d-flex mb-4">
                    <i class="fa fa-star text-secondary"></i>
                    <i class="fa fa-star text-secondary"></i>
                    <i class="fa fa-star text-secondary"></i>
                    <i class="fa fa-star text-secondary"></i>
                    <i class="fa fa-star"></i>
                  </div>
                  <p class="mb-4">${selectedProduct.descripcion}</p>
                  <div class="input-group quantity mb-5" style="width: 100px">
                    <div class="input-group-btn">
                      <button class="btn btn-sm btn-minus rounded-circle bg-light border">
                        <i class="fa fa-minus"></i>
                      </button>
                    </div>
                    <input type="text" class="form-control form-control-sm text-center border-0" value="1" data-quantity />
                    <div class="input-group-btn">
                      <button class="btn btn-sm btn-plus rounded-circle bg-light border">
                        <i class="fa fa-plus"></i>
                      </button>
                    </div>
                  </div>
                  <a class="btn border border-secondary rounded-pill px-4 py-2 mb-4 text-primary add-to-cart" data-id="${selectedProduct.id}">
                    <i class="fa fa-shopping-bag me-2 text-primary"></i> Agregar a carrito
                  </a>
                </div>
                <div class="col-lg-12">
                  <nav>
                    <div class="nav nav-tabs mb-3">
                      <button class="nav-link active border-white border-bottom-0" type="button" role="tab" id="nav-about-tab" data-bs-toggle="tab" data-bs-target="#nav-about" aria-controls="nav-about" aria-selected="true">Descripción</button>
                      <button class="nav-link border-white border-bottom-0" type="button" role="tab" id="nav-mission-tab" data-bs-toggle="tab" data-bs-target="#nav-mission" aria-controls="nav-mission" aria-selected="false">Opiniones</button>
                    </div>
                  </nav>
                  <div class="tab-content mb-5">
                    <div class="tab-pane active" id="nav-about" role="tabpanel" aria-labelledby="nav-about-tab">
                      <p>${selectedProduct.descripcion}</p>
                      <p>Nuestra ${selectedProduct.nombre} se obtiene de manera sostenible y se envía fresca para garantizar su máxima calidad. Perfecta para los amantes de la buena cocina que buscan ingredientes frescos y saludables.</p>
                      <div class="px-2">
                        <div class="row g-4">
                          <div class="col-6">
                            <div class="row bg-light align-items-center text-center justify-content-center py-2">
                              <div class="col-6"><p class="mb-0">Peso</p></div>
                              <div class="col-6"><p class="mb-0">1 kg</p></div>
                            </div>
                            <div class="row text-center align-items-center justify-content-center py-2">
                              <div class="col-6"><p class="mb-0">Lugar de origen</p></div>
                              <div class="col-6"><p class="mb-0">Agro Farm</p></div>
                            </div>
                            <div class="row bg-light text-center align-items-center justify-content-center py-2">
                              <div class="col-6"><p class="mb-0">Calidad</p></div>
                              <div class="col-6"><p class="mb-0">Fresco</p></div>
                            </div>
                            <div class="row text-center align-items-center justify-content-center py-2">
                              <div class="col-6"><p class="mb-0">Revisión</p></div>
                              <div class="col-6"><p class="mb-0">Saludable</p></div>
                            </div>
                            <div class="row bg-light text-center align-items-center justify-content-center py-2">
                              <div class="col-6"><p class="mb-0">Peso mínimo</p></div>
                              <div class="col-6"><p class="mb-0">250g</p></div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                    <div class="tab-pane" id="nav-mission" role="tabpanel" aria-labelledby="nav-mission-tab">
                      <div class="d-flex">
                        <img src="img/avatar.jpg" class="img-fluid rounded-circle p-3" style="width: 100px; height: 100px" alt="" />
                        <div class="">
                          <p class="mb-2" style="font-size: 14px">Diciembre 12, 2024</p>
                          <div class="d-flex justify-content-between">
                            <h5>María González</h5>
                            <div class="d-flex mb-3">
                              <i class="fa fa-star text-secondary"></i>
                              <i class="fa fa-star text-secondary"></i>
                              <i class="fa fa-star text-secondary"></i>
                              <i class="fa fa-star text-secondary"></i>
                              <i class="fa fa-star"></i>
                            </div>
                          </div>
                          <p>La ${selectedProduct.nombre} de esta tienda es sencillamente excepcional. Su frescura y textura son perfectas.</p>
                        </div>
                      </div>
                      <div class="d-flex">
                        <img src="img/avatar.jpg" class="img-fluid rounded-circle p-3" style="width: 100px; height: 100px" alt="" />
                        <div class="">
                          <p class="mb-2" style="font-size: 14px">Abril 12, 2024</p>
                          <div class="d-flex justify-content-between">
                            <h5>Juan Pérez</h5>
                            <div class="d-flex mb-3">
                              <i class="fa fa-star text-secondary"></i>
                              <i class="fa fa-star text-secondary"></i>
                              <i class="fa fa-star text-secondary"></i>
                              <i class="fa fa-star"></i>
                              <i class="fa fa-star"></i>
                            </div>
                          </div>
                          <p class="text-dark">Compré la ${selectedProduct.nombre} y quedé bastante satisfecho. La calidad es excelente.</p>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <form action="#">
                  <h4 class="mb-5 fw-bold">Deja un comentario</h4>
                  <div class="row g-4">
                    <div class="col-lg-6">
                      <div class="border-bottom rounded">
                        <input type="text" class="form-control border-0 me-4" placeholder="Tu nombre *" />
                      </div>
                    </div>
                    <div class="col-lg-6">
                      <div class="border-bottom rounded">
                        <input type="email" class="form-control border-0" placeholder="Tu correo *" />
                      </div>
                    </div>
                    <div class="col-lg-12">
                      <div class="border-bottom rounded my-4">
                        <textarea name="" id="" class="form-control border-0" cols="30" rows="8" placeholder="Tu comentario *" spellcheck="false"></textarea>
                      </div>
                    </div>
                    <div class="col-lg-12">
                      <div class="d-flex justify-content-between py-3 mb-5">
                        <div class="d-flex align-items-center">
                          <p class="mb-0 me-3">Por favor puntúa:</p>
                          <div class="d-flex align-items-center" style="font-size: 12px">
                            <i class="fa fa-star text-muted"></i>
                            <i class="fa fa-star"></i>
                            <i class="fa fa-star"></i>
                            <i class="fa fa-star"></i>
                            <i class="fa fa-star"></i>
                          </div>
                        </div>
                        <a href="#" class="btn border border-secondary text-primary rounded-pill px-4 py-3">Publicar comentario</a>
                      </div>
                    </div>
                  </div>
                </form>
              `;

              // Handle quantity buttons
              const quantityInput = singleProductContainer.querySelector('.quantity input[data-quantity]');
              const minusBtn = singleProductContainer.querySelector('.btn-minus');
              const plusBtn = singleProductContainer.querySelector('.btn-plus');

              minusBtn.addEventListener('click', () => {
                let value = parseInt(quantityInput.value);
                if (value > 1) {
                  quantityInput.value = value - 1;
                }
              });

              plusBtn.addEventListener('click', () => {
                let value = parseInt(quantityInput.value);
                quantityInput.value = value + 1;
              });

              // Handle main product add-to-cart
              singleProductContainer.querySelector('.add-to-cart').addEventListener('click', (e) => {
                e.preventDefault();
                if (!usuario_id) {
                  alert('Por favor, inicia sesión para añadir productos al carrito.');
                  window.location.href = 'Login.html';
                  return;
                }
                const productoId = parseInt(e.currentTarget.getAttribute('data-id'));
                const cantidad = parseInt(quantityInput.value);

                fetch('http://localhost/minemarket/api/agregar_carrito.php', {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json'
                  },
                  body: JSON.stringify({
                    usuario_id: usuario_id,
                    producto_id: productoId,
                    cantidad: cantidad
                  })
                })
                  .then(res => res.json())
                  .then(data => {
                    if (data.success) {
                      alert('Producto añadido al carrito');
                      updateCartCount();
                    } else {
                      alert('Error al agregar: ' + data.error);
                    }
                  })
                  .catch(err => {
                    console.error('Error de red:', err);
                    alert('Error de red al añadir al carrito.');
                  });
              });
            } else {
              singleProductContainer.innerHTML = `
                <div class="col-12">
                  <p class="text-danger text-center">Producto no encontrado.</p>
                </div>
              `;
            }
          })
          .catch(error => {
            console.error('Error fetching product:', error);
            singleProductContainer.innerHTML = `
              <div class="col-12">
                <p class="text-danger text-center">No se pudo cargar el producto. Por favor, intenta de nuevo más tarde.</p>
              </div>
            `;
          });

        // Fetch featured and related products
        fetch('http://localhost/minemarket/api/obtener_productos.php')
          .then(response => {
            if (!response.ok) {
              throw new Error('Network response was not ok');
            }
            return response.json();
          })
          .then(productos => {
            // Featured Products (exactly 6 items)
            const featuredProductsContainer = document.getElementById('featured-products');
            const featuredProducts = productos.slice(0, 6);
            featuredProducts.forEach(p => {
              const featuredItem = document.createElement('div');
              featuredItem.className = 'd-flex align-items-center justify-content-start';
              featuredItem.innerHTML = `
                <div class="rounded me-4" style="width: 100px; height: 100px">
                  <img src="${p.imagen_url}" class="img-fluid rounded" alt="${p.nombre}" />
                </div>
                <div>
                  <h6 class="mb-2">${p.nombre}</h6>
                  <div class="d-flex mb-2">
                    <i class="fa fa-star text-secondary"></i>
                    <i class="fa fa-star text-secondary"></i>
                    <i class="fa fa-star text-secondary"></i>
                    <i class="fa fa-star text-secondary"></i>
                    <i class="fa fa-star"></i>
                  </div>
                  <div class="d-flex mb-2">
                    <h5 class="fw-bold me-2">S/${parseFloat(p.precio).toFixed(2)}</h5>
                  </div>
                </div>
              `;
              featuredProductsContainer.appendChild(featuredItem);
            });

            // Related Products (exactly 8 items)
            const relatedProductsContainer = document.getElementById('related-products');
            const relatedProducts = productos
              .filter(p => p.id != productId)
              .slice(0, 8);
            relatedProducts.forEach(p => {
              const relatedItem = document.createElement('div');
              relatedItem.className = 'border border-primary rounded position-relative vesitable-item fruite-item';
              relatedItem.innerHTML = `
                <div class="vesitable-img fruite-img">
                  <a href="shop-detail.html?product_id=${p.id}">
                    <img src="${p.imagen_url}" class="img-fluid w-100 rounded-top" alt="${p.nombre}" />
                  </a>
                </div>
                <div class="text-white bg-primary px-2 py-1 rounded position-absolute" style="top: 5px; right: 5px; font-size: 0.7rem;">
                  ${p.categoria_nombre}
                </div>
                <div class="p-3 rounded-bottom">
                  <h5 style="font-size: 1rem;">${p.nombre}</h5>
                  <p style="font-size: 0.8rem;">${p.descripcion}</p>
                  <div class="d-flex justify-content-between flex-lg-wrap align-items-center">
                    <p class="text-dark fs-6 fw-bold mb-0">S/${parseFloat(p.precio).toFixed(2)}</p>
                    <a href="#" class="btn border border-secondary rounded-pill px-2 py-1 text-primary add-to-cart" data-id="${p.id}" style="font-size: 0.7rem;">
                      <i class="fa fa-shopping-bag me-1 text-primary"></i> Añadir
                    </a>
                  </div>
                </div>
              `;
              relatedProductsContainer.appendChild(relatedItem);
            });

            // Handle related products add-to-cart
            relatedProductsContainer.querySelectorAll('.add-to-cart').forEach(button => {
              button.addEventListener('click', (e) => {
                e.preventDefault();
                if (!usuario_id) {
                  alert('Por favor, inicia sesión para añadir productos al carrito.');
                  window.location.href = 'Login.html';
                  return;
                }
                const productoId = parseInt(e.currentTarget.getAttribute('data-id'));

                fetch('http://localhost/minemarket/api/agregar_carrito.php', {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json'
                  },
                  body: JSON.stringify({
                    usuario_id: usuario_id,
                    producto_id: productoId,
                    cantidad: 1
                  })
                })
                  .then(res => res.json())
                  .then(data => {
                    if (data.success) {
                      alert('Producto añadido al carrito');
                      updateCartCount();
                    } else {
                      alert('Error al agregar: ' + data.error);
                    }
                  })
                  .catch(err => {
                    console.error('Error de red:', err);
                    alert('Error de red al añadir al carrito.');
                  });
              });
            });

            // Reinitialize Owl Carousel for related products
            $(document).ready(function () {
              $("#related-products").owlCarousel({
                items: 3,
                loop: relatedProducts.length >= 3,
                margin: 15,
                nav: true,
                dots: false,
                responsive: {
                  0: { items: 1 },
                  600: { items: 2 },
                  1000: { items: 3 }
                }
              });
            });
          })
          .catch(error => {
            console.error('Error fetching products:', error);
            document.getElementById('featured-products').innerHTML = `
              <p class="text-danger text-center">No se pudieron cargar los productos destacados.</p>
            `;
            document.getElementById('related-products').innerHTML = `
              <p class="text-danger text-center">No se pudieron cargar los productos relacionados.</p>
            `;
          });
      });
    </script>
  </body>
</html>